import React,{useContext,useEffect,useState} from 'react'
import './ObjetivoTematico.css'
import { ContextAreaDeTrabajo } from '../../context/ContextAreaDeTrabajo';
import { useQuill } from 'react-quilljs';
import {BorrarRegsTabla} from '../helpers/GuardaEnBD.jsx'

export const ObjetivoTematico = () => {

     const {
          modalTipoSlide, setModalTipoSlide,
          slideSelected, setSlideSelected,
          setSlides,
          idUsuario,
          idProyectoActual,
          sesion,
          edicion, setEdicion,
          despCronograma, setDespCronograma,
          cv_crono_flag,cv_crono_tipo,
          setTipoCronograma,
     
          /** info GestiÃ³n slides: */
          paginacion, setPaginacion,
     
          /** Objetivo aprendizaje */
          modalObjetivoApr, setModalObjetivoApr,
          tipoObj, setTipoObj,
          tipoCont, setTipoCont,
          temporaqlidad, setTemporaqlidad,
          aprendiz, setAprendiz,
          verbo1, setVerbo1,
          verbo2, setVerbo2,
          verbo3, setVerbo3,
          verbo4, setVerbo4,
          verbo5, setVerbo5,
          verbo6, setVerbo6,
          contenido, setContenido,
          finalidad, setFinalidad,
          actividad, setActividad,
     
     } = useContext(ContextAreaDeTrabajo);     

     const [elimObjFlag, setElimObjFlag] = useState(false)


     /* Opciones Editor Quill */
     const placeholder = 'contenido...';      
     const modules = {
     toolbar: [
          ['bold', 'italic', 'underline', 'strike'],
          [{ align: [] }],
          [{ list: 'ordered'}, { list: 'bullet' }],
     ],
     };    
     const { quill, quillRef } = useQuill({placeholder,modules});

     useEffect( () =>{
          creaRegistroObjetivo();
          cargaValoresObjetivos2();
     },[]);

     useEffect( () =>{
          if (quill) {
            cargaValoresQuillObjetivo(slideSelected.id) 
             
            quill.on('text-change', (delta, oldDelta, source) => {                
              setContenido(quill.root.innerHTML)        
              actualizarRegBdSlideObjetivos("contenido",quill.root.innerHTML)
            });
          }          
        }, [quill]  )

     const cargaValoresQuillObjetivo  = (slideId) =>{
          setContenido('')
     const db = window.openDatabase("KRAKEN-SLIDES-3.2", "1.0", "LTA 1.0", 100000);
     db.transaction(function(tx) {
          tx.executeSql('SELECT * FROM ObjetivoApr WHERE id_usuario = ? AND id_proyecto = ? AND sesion = ?  AND slide = ?  ', [idUsuario,idProyectoActual,sesion,slideSelected.id], function(tx, results) {
               console.log("SELECT:"+idProyectoActual,sesion,slideSelected.id)
               let len = results.rows.length ;
                                   
               if(len > 0){                                  
                    setContenido(results.rows.item(0).contenido) 
                    quill.clipboard.dangerouslyPasteHTML(results.rows.item(0).contenido);                 
               }
          }, null);
     });
     }

     const cargaValoresObjetivos2 = (slideId) =>{
          console.warn('cargaValoresObjetivos2')
          const db = window.openDatabase("KRAKEN-SLIDES-3.2", "1.0", "LTA 1.0", 100000);
          db.transaction(function(tx) {
               console.warn('cargaValoresObjetivos2 - entro en fuction db',idUsuario,idProyectoActual,sesion,slideSelected.id)
               tx.executeSql('SELECT * FROM ObjetivoApr WHERE id_usuario = ? AND id_proyecto = ? AND sesion = ?  AND slide = ?  ', [idUsuario,idProyectoActual,sesion,slideSelected.id], function(tx, results) {
                    
                    console.warn('cargaValoresObjetivos2 - entro tx')
                    let len = 0;    
                    if( results.rows.length ){
                         len =10;
                    }
                    
                    if(len > 0){                                                                                    
                         setTipoObj(results.rows.item(0).tipoObj)
                         setTipoCont(results.rows.item(0).tipoCont)
                         setTemporaqlidad(results.rows.item(0).temporaqlidad)
                         setAprendiz(results.rows.item(0).aprendiz)
                         setVerbo1(results.rows.item(0).verbo1)
                         setVerbo2(results.rows.item(0).verbo2)
                         setVerbo3(results.rows.item(0).verbo3)
                         setVerbo4(results.rows.item(0).verbo4)
                         setVerbo5(results.rows.item(0).verbo5)
                         setVerbo6(results.rows.item(0).verbo6)
                         setContenido(results.rows.item(0).contenido)
                         setFinalidad(results.rows.item(0).finalidad)
                         setActividad(results.rows.item(0).actividad)
                    }
               }, null);
          });
     }





     const actualizarRegBdSlideObjetivos = async (variable,valor) =>{
          console.log("actualizarRegBdSlideObjetivos",variable,valor)
          
          switch (variable) {
               case "tipoObj":
                    setTipoObj(valor)
                    break;
               case "tipoCont":
                    setTipoCont(valor)
                    break;
               case "temporaqlidad":
                    setTemporaqlidad(valor)
                    break;
               case "aprendiz":
                    setAprendiz(valor)                    
                    break;
               case "finalidad":
                    setFinalidad(valor)
                    break;
               case "actividad":
                    setActividad(valor)
                    break;
          }



          const db = window.openDatabase("KRAKEN-SLIDES-3.2", "1.0", "LTA 1.0", 100000);
          db.transaction(function(tx) {
               tx.executeSql(`UPDATE ObjetivoApr SET ${variable} = ? WHERE id_proyecto = ? AND id_usuario = ? AND sesion = ? AND slide = ?`, [valor,idProyectoActual,idUsuario,sesion,slideSelected.id], function(tx, results) {
                    console.log('updateando')                    
               }, null);
          });
     }

     const actualizarRegBdSlideObjetivosVerbos = async (variable,valor) =>{
          let variablesVerbos='';
          switch (variable) {
               case 'verbo1':
                    variablesVerbos = `,verbo2='',verbo3='',verbo4='',verbo5='',verbo6='' `;
                    setVerbo1(valor);
                    setVerbo2('');
                    setVerbo3('');
                    setVerbo4('');
                    setVerbo5('');
                    setVerbo6('');
                    break;
               case 'verbo2':
                    variablesVerbos = `,verbo1='',verbo3='',verbo4='',verbo5='',verbo6='' `;
                    setVerbo1('');
                    setVerbo2(valor);
                    setVerbo3('');
                    setVerbo4('');
                    setVerbo5('');
                    setVerbo6('');
                    break;
               case 'verbo3':
                    variablesVerbos = `,verbo1='',verbo2='',verbo4='',verbo5='',verbo6='' `;
                    setVerbo1('');
                    setVerbo2('');
                    setVerbo3(valor);
                    setVerbo4('');
                    setVerbo5('');
                    setVerbo6('');
                    break;
               case 'verbo4':
                    variablesVerbos = `,verbo1='',verbo2='',verbo3='',verbo5='',verbo6='' `;
                    setVerbo1('');
                    setVerbo2('');
                    setVerbo3('');
                    setVerbo4(valor);
                    setVerbo5('');
                    setVerbo6('');
                    break;
               case 'verbo5':
                    variablesVerbos = `,verbo1='',verbo2='',verbo3='',verbo4='',verbo6='' `;
                    setVerbo1('');
                    setVerbo2('');
                    setVerbo3('');
                    setVerbo4('');
                    setVerbo5(valor);
                    setVerbo6('');
                    break;
               case 'verbo6':
                    variablesVerbos = `,verbo1='',verbo2='',verbo3='',verbo4='',verbo5='' `;
                    setVerbo1('');
                    setVerbo2('');
                    setVerbo3('');
                    setVerbo4('');
                    setVerbo5('');
                    setVerbo6(valor);
                    break;
          }


          const db = window.openDatabase("KRAKEN-SLIDES-3.2", "1.0", "LTA 1.0", 100000);
          db.transaction(function(tx) {
               tx.executeSql(`UPDATE ObjetivoApr SET ${variable} = ? ${variablesVerbos} WHERE id_proyecto = ? AND id_usuario = ? AND sesion = ? AND slide = ?`, [valor,idProyectoActual,idUsuario,sesion,slideSelected.id], function(tx, results) {
                    console.log('updateando')                    
               }, null);
          });
     }

     
     const creaRegistroObjetivo = async (variable,valor) =>{          
          const db = window.openDatabase("KRAKEN-SLIDES-3.2", "1.0", "LTA 1.0", 100000);
          db.transaction(function(tx) {
               tx.executeSql(`INSERT INTO ObjetivoApr (id_proyecto, id_usuario, sesion, slide) VALUES (?,?,?,?)`, [idProyectoActual,idUsuario,sesion,slideSelected.id], function(tx, results) {
                    console.log('results', results)                    
               }, null);
               
          });
     }

     const eliminarObjetivoFunciones = async () =>{
          BorrarRegsTabla(2,slideSelected.id,sesion,idProyectoActual,idUsuario)
          setModalObjetivoApr(false);  
     }


  return (
     <div className='contObjTematico' >
          <div className='contObjTematico-desp'>
               <div 
                    className='contObjTematico-desp-cerrar' 
                    onClick={() => setModalObjetivoApr(false)}
                    >
               <i className="fa-solid fa-xmark"></i></div>
               
               <div className='contObjTematico-desp-tlt' >Objetivo de aprendizaje</div>
               <div className='dosColumnas'>
                    <div className='contObjTematico-desp-form' >
                         
                         <div className='contObjTematico-desp-form-reg' >
                              <div className='contObjTematico-desp-form-reg-tlt' > Tipo de objetivo</div>
                              <select   
                                        onChange={ (e)=> actualizarRegBdSlideObjetivos('tipoObj', e.target.value) } 
                                        className='contObjTematico-desp-form-select' 
                                        value={tipoObj ? tipoObj : '0'}
                                        name="" 
                                        id=""
                                        >
                                   <option value="0" className='disebleOption' disabled selected  >Seleccione</option>
                                   <option value="1">General</option>
                                   <option value="2">Particular</option>
                                   <option value="3">EspecÃ­fico / temÃ¡tico</option>
                              </select>
                         </div>
                         
                         <div className='contObjTematico-desp-form-reg' >
                              <div className='contObjTematico-desp-form-reg-tlt' >Tipo de contenido</div>
                              <select 
                                   className='contObjTematico-desp-form-select' 
                                   onChange={ (e)=> actualizarRegBdSlideObjetivos('tipoCont', e.target.value) } 
                                   name="" 
                                   value={tipoCont ? tipoCont : '0'}
                                   id="">
                                   <option value="0" className='disebleOption' disabled selected  >Seleccione</option>
                                   <option value="1" >Declarativo</option>
                                   <option value="2"  >Procedimental</option>
                                   <option value="3"  >Actitudinal</option>
                              </select>
                         </div>

                         <div className='contObjTematico-desp-form-regtlt' >
                              RedacciÃ³n del objetivo
                         </div>
                         
                         <div className='contObjTematico-desp-form-reg' >
                              <div className='contObjTematico-desp-form-reg-tlt' >Temporalidad <span className='txtbajito' >Â¿cuÃ¡ndo?</span> </div>
                              <input 
                                   className='contObjTematico-desp-form-input' 
                                   type="text" 
                                   defaultValue={temporaqlidad}
                                   onChange={ (e)=> setTemporaqlidad(e.target.value) }
                                   onBlur={ (e)=> actualizarRegBdSlideObjetivos('temporaqlidad', e.target.value) } 
                                   />
                         </div>
                         <div className='contObjTematico-desp-form-reg' >
                              <div className='contObjTematico-desp-form-reg-tlt' >Aprendiz <span className='txtbajito' >Â¿quiÃ©n?</span></div>
                              <input 
                                   className='contObjTematico-desp-form-input' 
                                   type="text"
                                   defaultValue={aprendiz} 
                                   onChange={ (e)=> actualizarRegBdSlideObjetivos('aprendiz', e.target.value) } 
                                   />
                         </div>
                         <div className='contObjTematico-desp-form-reg' >
                              <div className='contObjTematico-desp-form-reg-tlt' >Verbo de acciÃ³n <span className='txtbajito' >Â¿quÃ©?</span></div> 
                                        <div className='contenedorSelects' >
                                             <select 
                                                  className='contObjTematico-desp-form-select' 
                                                  onChange={ (e)=> actualizarRegBdSlideObjetivosVerbos('verbo1', e.target.value) } 
                                                  value={verbo1 ? verbo1 : '0'}
                                                  name="" 
                                                  id=""
                                                  >
                                                  <option value="0" className='disebleOption' disabled  >CONOCIMIENTO</option>
                                                  <option value="repetirÃ¡">RepetirÃ¡</option>
                                                  <option value="reproducirÃ¡">ReproducirÃ¡</option>
                                                  <option value="adquirirÃ¡">AdquirirÃ¡</option>
                                                  <option value="recordarÃ¡">RecordarÃ¡</option>
                                                  <option value="reconocerÃ¡">ReconocerÃ¡</option>
                                                  <option value="identificarÃ¡">IdentificarÃ¡</option>
                                                  <option value="localizarÃ¡">LocalizarÃ¡</option>
                                                  <option value="hallarÃ¡">HallarÃ¡</option>
                                                  <option value="nombrarÃ¡">NombrarÃ¡</option>
                                                  <option value="marcarÃ¡">MarcarÃ¡</option>
                                                  <option value="apuntarÃ¡">ApuntarÃ¡</option>
                                                  <option value="subrayarÃ¡">SubrayarÃ¡</option>
                                                  <option value="registrarÃ¡">RegistrarÃ¡</option>
                                                  <option value="enlistarÃ¡">EnlistarÃ¡</option>
                                                  <option value="enunciarÃ¡">EnunciarÃ¡</option>
                                                  <option value="declararÃ¡">DeclararÃ¡</option>
                                                  <option value="expresarÃ¡">ExpresarÃ¡</option>
                                                  <option value="relatarÃ¡">RelatarÃ¡</option>
                                                  <option value="escribirÃ¡">EscribirÃ¡</option>
                                                  <option value="describirÃ¡">DescribirÃ¡</option>
                                                  <option value="definirÃ¡">DefinirÃ¡</option>
                                             </select>
                                             <select 
                                                  className='contObjTematico-desp-form-select' 
                                                  onChange={ (e)=> actualizarRegBdSlideObjetivosVerbos('verbo2', e.target.value) } 
                                                  value={verbo2 ? verbo2 : '0'}
                                                  name="1" 
                                                  id="e"
                                                  >
                                                  <option value="0" className='disebleOption' disabled  >COMPRENSIÃN</option>
                                                  <option value="revisarÃ¡">RevisarÃ¡</option>
                                                  <option value="reafirmarÃ¡">ReafirmarÃ¡</option>
                                                  <option value="comprenderÃ¡">ComprenderÃ¡</option>
                                                  <option value="entenderÃ¡">EntenderÃ¡</option>
                                                  <option value="tdentificarÃ¡">IdentificarÃ¡</option>
                                                  <option value="localizarÃ¡">LocalizarÃ¡</option>
                                                  <option value="expresarÃ¡">ExpresarÃ¡</option>
                                                  <option value="narrarÃ¡">NarrarÃ¡</option>
                                                  <option value="describirÃ¡">DescribirÃ¡</option>
                                                  <option value="traducirÃ¡">TraducirÃ¡</option>
                                                  <option value="transcribirÃ¡">TranscribirÃ¡</option>
                                                  <option value="ilustrarÃ¡">IlustrarÃ¡</option>
                                                  <option value="dibujarÃ¡">DibujarÃ¡</option>
                                                  <option value="discutirÃ¡">DiscutirÃ¡</option>
                                                  <option value="explicarÃ¡">ExplicarÃ¡</option>
                                                  <option value="interpretarÃ¡">InterpretarÃ¡</option>
                                                  <option value="inferirÃ¡">InferirÃ¡</option>
                                             </select>
                                             <select 
                                                  className='contObjTematico-desp-form-select' 
                                                  onChange={ (e)=> actualizarRegBdSlideObjetivosVerbos('verbo3', e.target.value) } 
                                                  value={verbo3 ? verbo3 : '0'}
                                                  name="2" 
                                                  id="e"
                                                  >
                                                  <option value="0" className='disebleOption' disabled  >APLICACIÃN</option>
                                                  <option value="ilustrarÃ¡">IlustrarÃ¡</option>
                                                  <option value="esbozarÃ¡">EsbozarÃ¡</option>
                                                  <option value="trazarÃ¡">TrazarÃ¡</option>
                                                  <option value="dramatizarÃ¡">DramatizarÃ¡</option>
                                                  <option value="construirÃ¡">ConstruirÃ¡</option>
                                                  <option value="explicarÃ¡">ExplicarÃ¡</option>
                                                  <option value="interpretarÃ¡">InterpretarÃ¡</option>
                                                  <option value="mostrarÃ¡">MostrarÃ¡</option>
                                                  <option value="desarrollarÃ¡">DesarrollarÃ¡</option>
                                                  <option value="inferirÃ¡">InferirÃ¡</option>
                                                  <option value="iventariarÃ¡">IventariarÃ¡</option>
                                                  <option value="relacionarÃ¡">RelacionarÃ¡</option>
                                                  <option value="transferirÃ¡">TransferirÃ¡</option>
                                                  <option value="aplicarÃ¡">AplicarÃ¡</option>
                                                  <option value="ejecutarÃ¡">EjecutarÃ¡</option>
                                                  <option value="construirÃ¡">ConstruirÃ¡</option>
                                                  <option value="usarÃ¡">UsarÃ¡</option>
                                                  <option value="operarÃ¡">OperarÃ¡</option>
                                                  <option value="emplearÃ¡">EmplearÃ¡</option>
                                                  <option value="prÃ¡cticarÃ¡">PrÃ¡cticarÃ¡</option>
                                             </select>
                                             <select 
                                                  className='contObjTematico-desp-form-select' 
                                                  onChange={ (e)=> actualizarRegBdSlideObjetivosVerbos('verbo4', e.target.value) } 
                                                  value={verbo4 ? verbo4 : '0'}
                                                  name="3" 
                                                  id="e"
                                                  >
                                                  <option value="0" className='disebleOption' disabled  >ANÃLISIS</option>
                                                  <option value="coordinarÃ¡">CoordinarÃ¡</option>
                                                  <option value="regularÃ¡">RegularÃ¡</option>
                                                  <option value="regularizarÃ¡">RegularizarÃ¡</option>
                                                  <option value="ordenarÃ¡">OrdenarÃ¡</option>
                                                  <option value="acoplarÃ¡">AcoplarÃ¡</option>
                                                  <option value="vincularÃ¡">VincularÃ¡</option>
                                                  <option value="concatenarÃ¡">ConcatenarÃ¡</option>
                                                  <option value="manipularÃ¡">ManipularÃ¡</option>
                                             </select>
                                             <select 
                                                  className='contObjTematico-desp-form-select' 
                                                  onChange={ (e)=> actualizarRegBdSlideObjetivosVerbos('verbo5', e.target.value) } 
                                                  value={verbo5 ? verbo5 : '0'}
                                                  name="4" 
                                                  id="e"
                                                  >
                                                  <option value="0" className='disebleOption' disabled  >SÃNTESIS</option>
                                                  <option value="sistematizarÃ¡">SistematizarÃ¡</option>
                                                  <option value="simplificarÃ¡">SimplificarÃ¡</option>
                                                  <option value="reducirÃ¡">ReducirÃ¡</option>
                                                  <option value="mecanizarÃ¡">MecanizarÃ¡</option>
                                                  <option value="codificarÃ¡">CodificarÃ¡</option>
                                                  <option value="computarizarÃ¡">ComputarizarÃ¡</option>
                                             </select>
                                             <select 
                                                  className='contObjTematico-desp-form-select' 
                                                  onChange={ (e)=> actualizarRegBdSlideObjetivosVerbos('verbo6', e.target.value) } 
                                                  value={verbo6 ? verbo6 : '0'}
                                                  name="5" 
                                                  id="e"
                                                  >
                                                  <option value="0" className='disebleOption' disabled  >EVALUACIÃN</option>
                                                  <option value="solucionarÃ¡"   className='disebleOptionNormal'>SolucionarÃ¡</option>
                                                  <option value="idearÃ¡"        className='disebleOptionNormal'>IdearÃ¡</option>
                                                  <option value="esquematizarÃ¡" className='disebleOptionNormal'>EsquematizarÃ¡</option>
                                                  <option value="inventarÃ¡"     className='disebleOptionNormal'>InventarÃ¡</option>
                                                  <option value="improvisarÃ¡"   className='disebleOptionNormal'>ImprovisarÃ¡</option>
                                                  <option value="crearÃ¡"        className='disebleOptionNormal'>CrearÃ¡</option>
                                                  <option value="diseÃ±arÃ¡"      className='disebleOptionNormal'>DiseÃ±arÃ¡</option>
                                             </select>
                                        </div>
                                   </div>

                              <div className=' objetivoQuill' >
                                   <div className='contObjTematico-desp-form-reg-tlt' >Contenido <span className='txtbajito' >Â¿cuÃ¡l?</span></div> 
                                   <div className='editorQuill editorQuill2 ' ><div ref={quillRef} /></div>         
                              </div>
                              <div className='contObjTematico-desp-form-reg' >
                                   <div className='contObjTematico-desp-form-reg-tlt' >Finalidad <span className='txtbajito' >Â¿cÃ³mo? y/o Â¿para quÃ©?</span></div>
                                   <input 
                                        className='contObjTematico-desp-form-input' 
                                        onChange={ (e)=> actualizarRegBdSlideObjetivos('finalidad', e.target.value) } 
                                        type="text" 
                                        value={finalidad ? finalidad : ''}
                                   />
                              </div>
                              <div className='contObjTematico-desp-form-reg' >
                                   <div className='contObjTematico-desp-form-reg-tlt' >Actividad de evaluaciÃ³n</div>
                                             <select 
                                                  className='contObjTematico-desp-form-select' 
                                                  onChange={  (e)=> actualizarRegBdSlideObjetivos('actividad', e.target.value) } 
                                                  value={actividad ? actividad : '0'}
                                                  name="" 
                                                  id=""
                                             >
                                                  <option value="0" className='disebleOption' disabled  >Seleccione</option>
                                                  <option value="prueba">Prueba</option>
                                                  <option value="examen">Examen</option>
                                                  <option value="tarea">Tarea</option>
                                                  <option value="proyecto">Proyecto</option>
                                             </select>
                              </div>



                    </div>
                    <div className='vistaPreviaObjetivo' >
                         
                         <div className='vistaPreviaObjetivo-concatenado' >  <div dangerouslySetInnerHTML={{__html: 
                                        (temporaqlidad? temporaqlidad : '' )+" "+
                                        (aprendiz ? aprendiz:'')+" "+
                                        (verbo1 ? verbo1 : '')+
                                        (verbo2 ? verbo2 : '')+
                                        (verbo3 ? verbo3 : '')+
                                        (verbo4 ? verbo4 : '')+
                                        (verbo5 ? verbo5 : '')+
                                        (verbo6 ? verbo6 : '')+ " "+                                        
                                        (contenido ? contenido.substring(3, contenido.length-4 ) : " ")  +" "+
                                        (finalidad ? finalidad : '')  }} ></div> </div>
                         <br/><br/>
                         <div className='btnElimObjetivo' onClick={ ()=>setElimObjFlag(true) } >Eliminar Objetivo de aprendizaje</div>
                         {
                              elimObjFlag && 
                                   <div className='msgElimObj' >
                                        Â¿Confirma eliminar el objetivo de aprendizaje?
                                        <div className='deplBtnsOnjsMsg' >
                                             <div 
                                                  className='btnElimObjetivoSi' 
                                                  onClick={ 
                                                       ()=>eliminarObjetivoFunciones()        
                                                  } 
                                                  >Eliminar</div>
                                             <div className='btnElimObjetivoNo' onClick={ ()=>setElimObjFlag(false) } >Cancelar</div>
                                        </div>
                                        
                                   </div>
                         }
                    </div>
               </div>

          </div>
     </div>
  )
}
 